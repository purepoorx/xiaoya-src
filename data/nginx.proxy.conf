proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=apicache:500m inactive=10m;
limit_req_zone $binary_remote_addr zone=two:500m rate=10r/s;

map $http_x_forwarded_proto $client_scheme {    
    default $http_x_forwarded_proto;    
    '' $scheme;    
}

server {
        listen 80 default_server;
		listen [::]:80;
        server_name _;
		#add_header Access-Control-Allow-Origin *;

	location /search {
		proxy_pass http://127.0.0.1:81/cgi-bin/search;
	}

        location /sou {
                proxy_pass http://127.0.0.1:81/cgi-bin/sou;
        }

        location /whatsnew {
                proxy_pass http://127.0.0.1:81/cgi-bin/whatsnew;
        }

        location ~ ^/image/(.*)$ {
                resolver 223.5.5.5 119.29.29.29 114.114.114.114;
                proxy_set_header Referer "https://servicewechat.com/wx2f9b06c1de1ccfca/84/page-frame.html";
                proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36 MicroMessenger/7.0.9.501 NetType/WIFI MiniProgramEnv/Windows WindowsWechat"; 
                proxy_pass      https://$1;
                proxy_set_header Host $proxy_host;
                proxy_cache apicache;
                proxy_buffering on;
        }

        location /foliate-js {
                proxy_pass http://127.0.0.1:81/foliate-js;
        }

		location /data {
			proxy_pass http://127.0.0.1:81/data;
		}

		location /tvbox {
				#auth_basic "Restricted Access";
				#auth_basic_user_file /www/tvbox/.htpasswd;
				proxy_pass http://127.0.0.1:81/tvbox;
                proxy_set_header Accept-Encoding "";
                sub_filter "DOCKER_ADDRESS" $client_scheme://$http_host;
                sub_filter_once off;
                sub_filter_types *;
                proxy_cache apicache;
		}

        location /tvbox/cat {
                auth_basic "Restricted Access";
                auth_basic_user_file /www/tvbox/cat/.htpasswd;
                proxy_pass http://127.0.0.1:81/tvbox/cat;
                proxy_set_header Accept-Encoding "";
                sub_filter "DOCKER_ADDRESS" $client_scheme://$http_host;
                sub_filter_once off;
                sub_filter_types *;
                proxy_cache apicache;
        }

        location / {
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header X-Forwarded-Host $http_host;
                proxy_set_header Host $http_host;
				#proxy_set_header User-Agent: $http_user_agent;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header Range $http_range;
                proxy_set_header If-Range $http_if_range;
                proxy_redirect off;
                proxy_pass http://127.0.0.1:5244;
				proxy_cache apicache;
                client_max_body_size 20000m;
        }

        location ~* ^/[dp]/.*夸克 {               
                if ($http_user_agent !~* "pckk_other_ch") {
                        rewrite ^(.*)$ #xiaoyaproxy/proxy?do=gen&url=$client_scheme://$http_host$1&size=500000&thread=16 ;
                }                  
                if ($http_user_agent ~* "pckk_other_ch") {
                        proxy_pass http://127.0.0.1:5244;
                }             
        }

        location /dav {
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				proxy_set_header X-Forwarded-Host $http_host;
                proxy_set_header Host $http_host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header Range $http_range;
                proxy_set_header If-Range $http_if_range;
                proxy_redirect off;
                proxy_pass http://127.0.0.1:5244/dav;
                proxy_cache apicache;
				limit_req zone=two burst=10;
        }

        location ^~ /@manage {
                deny all;
        }

        location ^~ /api/admin {
               deny all;
        }

        location ^~ /api/fs/copy {
                deny all;
        }

        location ^~ /api/fs/move {
                deny all;
        }

        location ^~ /api/fs/mkdir {
                deny all;
        }

        location ^~ /api/fs/put {
                deny all;
        }

	location ^~ /api/fs/search {
                deny all;
        }

}
